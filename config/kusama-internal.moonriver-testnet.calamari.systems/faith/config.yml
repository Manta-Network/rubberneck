---
hostname: faith
domain: kusama-internal.moonriver-testnet.calamari.systems
action: sync
provider: aws-dev
dns:
  alias:
    -
      name: ws.kusama-internal.moonriver-testnet.calamari.systems
      weight: 200
    -
      name: ws.archive.kusama-internal.moonriver-testnet.calamari.systems
      weight: 200
user:
  -
    username: root
    authorized:
      keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGhEy3dlSZZtj9RI+g7Q7K5n01cvTQryCMCDpkTqfF3/
  -
    username: mobula
    authorized:
      keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJIBSdR9Wy3S4L+Zdcu8waYe5vW2VzMoi+QafgV3IIFj
      users:
        - stechu
        - garandor
        - ghzlatarev
command:
  - sudo passwd -l root
  - 'sudo sed -i "s/# server_names_hash_bucket_size 64;/server_names_hash_bucket_size 128;/" /etc/nginx/nginx.conf'
  - systemctl is-active moonriver.service || sudo systemctl restart moonriver.service
  - systemctl is-active nginx.service || sudo systemctl restart nginx.service
  - systemctl is-active prometheus-node-exporter.service || sudo systemctl restart prometheus-node-exporter.service
  - timedatectl show | grep Timezone=UTC &> /dev/null || sudo timedatectl set-timezone UTC
  - 'test -s /etc/letsencrypt/renewal/$(hostname -f).conf || sudo certbot certonly --noninteractive --cert-name $(hostname -f) --expand --allow-subset-of-names -m ops@manta.network --agree-tos --no-eff-email --preferred-challenges http --webroot --webroot-path /var/www/html -d $(hostname -f)'
  - 'test -s /etc/letsencrypt/renewal/$(hostname -f).conf && sudo rm -f /etc/nginx/sites-enabled/default'
  - test -x /usr/local/bin/node_exporter || ( curl -sLo /tmp/node_exporter-1.3.1.linux-amd64.tar.gz https://github.com/prometheus/node_exporter/releases/download/v1.3.1/node_exporter-1.3.1.linux-amd64.tar.gz && sudo tar xvfz /tmp/node_exporter-1.3.1.linux-amd64.tar.gz -C /usr/local/bin --strip-components=1 node_exporter-1.3.1.linux-amd64/node_exporter )
  - test -x /usr/local/bin/go-audit || ( curl -sLo /tmp/go-audit-linux-amd64.tar.gz https://github.com/slackhq/go-audit/releases/download/v1.1.1/go-audit-linux-amd64.tar.gz && sudo tar xvfz /tmp/go-audit-linux-amd64.tar.gz -C /usr/local/bin )
file:
  -
    source: 'https://gist.githubusercontent.com/grenade/0ecdf893ee41662b8715c1ae29716272/raw/elastic-8.x.list'
    target: /etc/apt/sources.list.d/elastic-8.x.list
    sha256: b35d6eebad5395d73ca10f67c179dbf90c14717497898d28f74b1b16b9320e1f
    command:
      pre:
        - sudo mkdir -p /root/.gnupg
        - sudo chmod 700 /root/.gnupg
        - sudo apt-get install -y dirmngr
        - sudo gpg --keyserver hkps://pgp.mit.edu --no-default-keyring --keyring /usr/share/keyrings/elastic.gpg --recv-keys D88E42B4
      post:
        - sudo apt-get update
  -
    source: 'https://gist.githubusercontent.com/grenade/0ecdf893ee41662b8715c1ae29716272/raw/filebeat-moonriver.yml'
    target: /etc/filebeat/filebeat.yml
    sha256: 9589df82ef2f833422a2bd9e7c4ab824e19d778452b3ceaddf07501ca90e9d1b
    command:
      pre:
        - sudo apt-get install -y filebeat
      post:
        - systemctl is-enabled filebeat.service || sudo systemctl enable filebeat.service
        - systemctl is-active filebeat.service && sudo systemctl restart filebeat.service
        - systemctl is-active filebeat.service || sudo systemctl start filebeat.service
  -
    source: 'https://gist.githubusercontent.com/grenade/cc6f567219f328f0aa468b4744230ffe/raw/prometheus-node-exporter.service'
    target: /etc/systemd/system/prometheus-node-exporter.service
    sha256: 4e551485c07fb89f348fd154f264a52cded39e87b6b8f8aad9115b1d353ede05
    command:
      pre:
        - ( systemctl is-active --quiet prometheus-node-exporter.service && sudo systemctl stop prometheus-node-exporter.service ) || true
      post:
        - sudo systemctl daemon-reload
        - systemctl is-enabled --quiet prometheus-node-exporter.service || sudo systemctl enable prometheus-node-exporter.service
        - systemctl is-active --quiet prometheus-node-exporter.service || sudo systemctl start prometheus-node-exporter.service
  -
    source: 'https://gist.githubusercontent.com/grenade/8ca7512fda41fd73c9d8dbe3fe7a548e/raw/go-audit.yml'
    target: /etc/go-audit.yml
    sha256: 8267a422d920a249b9d744a322c0824a14f2fd8acc0f88aa9caf0fae604f5ef1
    command:
      post:
        - systemctl is-active --quiet go-audit.service && sudo systemctl restart go-audit.service
  -
    source: 'https://gist.githubusercontent.com/grenade/8ca7512fda41fd73c9d8dbe3fe7a548e/raw/go-audit.service'
    target: /etc/systemd/system/go-audit.service
    sha256: bd5536398fd1fb4b18fbbb951d86960851d47cc68a41d5bbb5ea591f9d635cf8
    command:
      pre:
        - ( systemctl is-active --quiet go-audit.service && sudo systemctl stop go-audit.service ) || true
      post:
        - sudo systemctl daemon-reload
        - systemctl is-enabled --quiet go-audit.service || sudo systemctl enable go-audit.service
        - systemctl is-active --quiet go-audit.service || sudo systemctl start go-audit.service
  -
    source: 'https://gist.githubusercontent.com/grenade/ad1a4772c47a0977204edee78691fde1/raw/options-ssl-nginx.conf'
    target: /etc/letsencrypt/options-ssl-nginx.conf
    sha256: 17baec778c05571beb0cdeb0bc1c6da3596d44d1fe567e7fee0efef80a860d01
    command:
      pre:
        - test -d /etc/letsencrypt || sudo mkdir -p /etc/letsencrypt
      post:
        - sudo chmod 644 /etc/letsencrypt/options-ssl-nginx.conf
  -
    source: 'https://gist.githubusercontent.com/grenade/ad1a4772c47a0977204edee78691fde1/raw/ssl-dhparams.pem'
    target: /etc/letsencrypt/ssl-dhparams.pem
    sha256: 9ba6429597aeed2d8617a7705b56e96d044f64b07971659382e426675105654b
    command:
      pre:
        - test -d /etc/letsencrypt || sudo mkdir -p /etc/letsencrypt
      post:
        - sudo chmod 644 /etc/letsencrypt/ssl-dhparams.pem
  -
    source: 'https://gist.githubusercontent.com/grenade/8ca7512fda41fd73c9d8dbe3fe7a548e/raw/status.conf'
    target: /etc/nginx/sites-available/status.conf
    sha256: c123caec7c2871afd3500875adb026cacffc16b7c7dde4375376d1b4fb3f1f14
    command:
      pre:
        - test -d /etc/nginx/sites-available || sudo mkdir -p /etc/nginx/sites-available
        - test -d /etc/nginx/sites-enabled || sudo mkdir -p /etc/nginx/sites-enabled
      post:
        - sudo ln -sfr /etc/nginx/sites-available/status.conf /etc/nginx/sites-enabled/status.conf
  -
    source: 'https://raw.githubusercontent.com/Manta-Network/rubberneck/main/config/kusama-internal.moonriver-testnet.calamari.systems/faith/etc/nginx/sites-available/substrate.conf'
    target: /etc/nginx/sites-available/substrate.conf
    sha256: 3e2ccf5de697099da6f03e85497e9517e20754c8aaa90ac04bbbef219705f273
    command:
      pre:
        - test -d /etc/nginx/sites-available || sudo mkdir -p /etc/nginx/sites-available
        - test -d /etc/nginx/sites-enabled || sudo mkdir -p /etc/nginx/sites-enabled
      post:
        - sudo ln -sfr /etc/nginx/sites-available/substrate.conf /etc/nginx/sites-enabled/substrate.conf
        - sudo systemctl stop nginx.service
        - sudo systemctl start nginx.service
  -
    source: 'https://gist.githubusercontent.com/grenade/8ca7512fda41fd73c9d8dbe3fe7a548e/raw/ws.kusama-internal.moonriver-testnet.calamari.systems.conf'
    target: /etc/nginx/sites-available/ws.kusama-internal.moonriver-testnet.calamari.systems.conf
    sha256: b911586d835aacc5f93880b8229f83fe3386f371169a87cf499141428067343d
    command:
      pre:
        - test -d /etc/nginx/sites-available || sudo mkdir -p /etc/nginx/sites-available
        - test -d /etc/nginx/sites-enabled || sudo mkdir -p /etc/nginx/sites-enabled
      post:
        - sudo ln -sfr /etc/nginx/sites-available/ws.kusama-internal.moonriver-testnet.calamari.systems.conf /etc/nginx/sites-enabled/ws.kusama-internal.moonriver-testnet.calamari.systems.conf
        - systemctl is-active --quiet nginx.service && sudo systemctl restart nginx.service
  -
    source: 'https://gist.githubusercontent.com/grenade/8ca7512fda41fd73c9d8dbe3fe7a548e/raw/ws.archive.kusama-internal.moonriver-testnet.calamari.systems.conf'
    target: /etc/nginx/sites-available/ws.archive.kusama-internal.moonriver-testnet.calamari.systems.conf
    sha256: 63e74bdb4b0599bd629985bf7bfac21adc4db930edc2cc690ff5e266add5a20c
    command:
      pre:
        - test -d /etc/nginx/sites-available || sudo mkdir -p /etc/nginx/sites-available
        - test -d /etc/nginx/sites-enabled || sudo mkdir -p /etc/nginx/sites-enabled
      post:
        - sudo ln -sfr /etc/nginx/sites-available/ws.archive.kusama-internal.moonriver-testnet.calamari.systems.conf /etc/nginx/sites-enabled/ws.archive.kusama-internal.moonriver-testnet.calamari.systems.conf
        - systemctl is-active --quiet nginx.service && sudo systemctl restart nginx.service
