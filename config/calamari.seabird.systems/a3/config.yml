---
hostname: a3
domain: calamari.seabird.systems
action: sync
provider: hetzner-robot
dns:
  alias:
    -
      name: ws.calamari.seabird.systems
    -
      name: ws.archive.calamari.seabird.systems
package:
  - auditd
  - certbot
  - dirmngr
  - nginx
  - python3-certbot-nginx
  - sqlite3
user:
  -
    username: root
    authorized:
      keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBZ/7EBrBGj975hyT5sNROd9FTym7yGoiX4wUL+DcDpY
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGhEy3dlSZZtj9RI+g7Q7K5n01cvTQryCMCDpkTqfF3/
  -
    username: mobula
    authorized:
      keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJIBSdR9Wy3S4L+Zdcu8waYe5vW2VzMoi+QafgV3IIFj
      users:
        - stechu
        - ferrell-code
        - garandor
        - ghzlatarev
command:
  - sudo passwd -l root
  - systemctl is-active calamari.service || sudo systemctl restart calamari.service
  - systemctl is-active manta-indexer.service || sudo systemctl manta-indexer calamari.service
  - systemctl is-active nginx.service || sudo systemctl restart nginx.service
  - systemctl is-active prometheus-node-exporter.service || sudo systemctl restart prometheus-node-exporter.service
  - timedatectl show | grep Timezone=UTC &> /dev/null || sudo timedatectl set-timezone UTC
  - 'test -s /etc/letsencrypt/renewal/$(hostname -f).conf || sudo certbot certonly --noninteractive --cert-name $(hostname -f) --expand --allow-subset-of-names -m ops@manta.network --agree-tos --no-eff-email --preferred-challenges http --webroot --webroot-path /var/www/html -d $(hostname -f)'
  - 'test -s /etc/letsencrypt/renewal/$(hostname -f).conf && sudo rm -f /etc/nginx/sites-enabled/default'
  - test -x /usr/local/bin/node_exporter || ( curl -sLo /tmp/node_exporter-1.3.1.linux-amd64.tar.gz https://github.com/prometheus/node_exporter/releases/download/v1.3.1/node_exporter-1.3.1.linux-amd64.tar.gz && sudo tar xvfz /tmp/node_exporter-1.3.1.linux-amd64.tar.gz -C /usr/local/bin --strip-components=1 node_exporter-1.3.1.linux-amd64/node_exporter )
  - test -x /usr/local/bin/go-audit || ( curl -sLo /tmp/go-audit-linux-amd64.tar.gz https://github.com/slackhq/go-audit/releases/download/v1.1.1/go-audit-linux-amd64.tar.gz && sudo tar xvfz /tmp/go-audit-linux-amd64.tar.gz -C /usr/local/bin )
  - test -x /usr/bin/unzip || sudo apt-get install -y unzip
  - test -x /usr/local/bin/promtail-linux-amd64 || ( curl -Lo /tmp/promtail-linux-amd64.zip https://github.com/grafana/loki/releases/download/v2.6.1/promtail-linux-amd64.zip && sudo unzip /tmp/promtail-linux-amd64.zip -d /usr/local/bin )
file:
  -
    source: https://gist.githubusercontent.com/grenade/74b5da418ac15b3c9679c1ec6b16f821/raw/promtail.service
    target: /etc/systemd/system/promtail.service
    sha256: 35ab9c5313c3729bf7cdedde972cf7b6e566d75bc5789edd88ab034a4e14096a
    command:
      pre:
        - ( systemctl is-active --quiet promtail.service && sudo systemctl stop promtail.service ) || true
      post:
        - sudo systemctl daemon-reload
        - systemctl is-enabled --quiet promtail.service || sudo systemctl enable promtail.service
        - systemctl is-active --quiet promtail.service || sudo systemctl start promtail.service
  -
    source: https://gist.githubusercontent.com/grenade/74b5da418ac15b3c9679c1ec6b16f821/raw/promtail.yml
    target: /etc/promtail/promtail.yml
    sha256: 3ad396de6e1becc80616339a413c0c1c8e21f96a3ceba2294521fac26941a52e
    command:
      pre:
        - sudo mkdir -p /etc/promtail
        - ( systemctl is-active --quiet promtail.service && sudo systemctl stop promtail.service ) || true
      post:
        - sudo systemctl daemon-reload
        - systemctl is-active --quiet promtail.service || sudo systemctl start promtail.service
  -
    source: 'https://gist.githubusercontent.com/grenade/cc6f567219f328f0aa468b4744230ffe/raw/prometheus-node-exporter.service'
    target: /etc/systemd/system/prometheus-node-exporter.service
    sha256: 4e551485c07fb89f348fd154f264a52cded39e87b6b8f8aad9115b1d353ede05
    command:
      pre:
        - ( systemctl is-active --quiet prometheus-node-exporter.service && sudo systemctl stop prometheus-node-exporter.service ) || true
      post:
        - sudo systemctl daemon-reload
        - systemctl is-enabled --quiet prometheus-node-exporter.service || sudo systemctl enable prometheus-node-exporter.service
        - systemctl is-active --quiet prometheus-node-exporter.service || sudo systemctl start prometheus-node-exporter.service
  -
    source: 'https://gist.githubusercontent.com/grenade/8ca7512fda41fd73c9d8dbe3fe7a548e/raw/go-audit.yml'
    target: /etc/go-audit.yml
    sha256: 8267a422d920a249b9d744a322c0824a14f2fd8acc0f88aa9caf0fae604f5ef1
    command:
      post:
        - systemctl is-active --quiet go-audit.service && sudo systemctl restart go-audit.service
  -
    source: 'https://gist.githubusercontent.com/grenade/8ca7512fda41fd73c9d8dbe3fe7a548e/raw/go-audit.service'
    target: /etc/systemd/system/go-audit.service
    sha256: bd5536398fd1fb4b18fbbb951d86960851d47cc68a41d5bbb5ea591f9d635cf8
    command:
      pre:
        - ( systemctl is-active --quiet go-audit.service && sudo systemctl stop go-audit.service ) || true
      post:
        - sudo systemctl daemon-reload
        - systemctl is-enabled --quiet go-audit.service || sudo systemctl enable go-audit.service
        - systemctl is-active --quiet go-audit.service || sudo systemctl start go-audit.service
  -
    source: https://raw.githubusercontent.com/Manta-Network/rubberneck/main/static/usr/share/substrate/calamari-staging.json
    target: /usr/share/substrate/calamari-staging.json
    sha256: 700bc42a71a237989d67b87dcf82dca7875d1f767348506b34d3acbe4f9fffb0
    command:
      pre:
        - test -d /usr/share/substrate || sudo mkdir -p /usr/share/substrate
      post:
        - systemctl is-active --quiet calamari.service && sudo systemctl restart calamari.service
  -
    source: https://raw.githubusercontent.com/Manta-Network/rubberneck/main/static/usr/share/substrate/kusama-staging.json
    target: /usr/share/substrate/kusama-staging.json
    sha256: 6e0a5614a4f8a94052fd2663f153adbd34cb7794be3ac7691d8febd27c479541
    command:
      pre:
        - test -d /usr/share/substrate || sudo mkdir -p /usr/share/substrate
      post:
        - systemctl is-active --quiet calamari.service && sudo systemctl restart calamari.service
  -
    source: 'https://github.com/Manta-Network/Manta/releases/download/v4.0.0-rc1/manta'
    target: /usr/local/bin/manta
    sha256: b1517cbd2e90b2e03ce9c2f24236fb2089297bbb00b148a89d224668d0d06759
    command:
      pre:
        - systemctl is-active --quiet calamari.service && sudo systemctl stop calamari.service
      post:
        - sudo chmod +x /usr/local/bin/manta
        - sudo ln -sfr /usr/local/bin/manta /usr/local/bin/calamari
        - systemctl is-active --quiet calamari.service || sudo systemctl start calamari.service
  -
    source: https://raw.githubusercontent.com/Manta-Network/rubberneck/main/config/calamari.seabird.systems/a3/etc/systemd/system/calamari.service
    target: /etc/systemd/system/calamari.service
    sha256: 246c9c1dbac57bf500bf155bfeb588ecf2785e9bf033dcdd8f659a05c4ba2a5a
    command:
      pre:
        - systemctl is-active --quiet calamari.service && sudo systemctl stop calamari.service
      post:
        - getent passwd substrate &> /dev/null || sudo useradd --system --create-home --home-dir /var/lib/substrate --user-group substrate
        - sudo systemctl daemon-reload
        - systemctl is-enabled --quiet calamari.service || sudo systemctl enable calamari.service
        - sudo systemctl start calamari.service
  -
    source: 'https://gist.githubusercontent.com/grenade/ad1a4772c47a0977204edee78691fde1/raw/options-ssl-nginx.conf'
    target: /etc/letsencrypt/options-ssl-nginx.conf
    sha256: 17baec778c05571beb0cdeb0bc1c6da3596d44d1fe567e7fee0efef80a860d01
    command:
      pre:
        - test -d /etc/letsencrypt || sudo mkdir -p /etc/letsencrypt
      post:
        - sudo chmod 644 /etc/letsencrypt/options-ssl-nginx.conf
  -
    source: 'https://gist.githubusercontent.com/grenade/ad1a4772c47a0977204edee78691fde1/raw/ssl-dhparams.pem'
    target: /etc/letsencrypt/ssl-dhparams.pem
    sha256: 9ba6429597aeed2d8617a7705b56e96d044f64b07971659382e426675105654b
    command:
      pre:
        - test -d /etc/letsencrypt || sudo mkdir -p /etc/letsencrypt
      post:
        - sudo chmod 644 /etc/letsencrypt/ssl-dhparams.pem
  -
    source: 'https://gist.githubusercontent.com/grenade/8ca7512fda41fd73c9d8dbe3fe7a548e/raw/status.conf'
    target: /etc/nginx/sites-available/status.conf
    sha256: c123caec7c2871afd3500875adb026cacffc16b7c7dde4375376d1b4fb3f1f14
    command:
      pre:
        - test -d /etc/nginx/sites-available || sudo mkdir -p /etc/nginx/sites-available
        - test -d /etc/nginx/sites-enabled || sudo mkdir -p /etc/nginx/sites-enabled
      post:
        - sudo ln -sfr /etc/nginx/sites-available/status.conf /etc/nginx/sites-enabled/status.conf
  -
    source: 'https://raw.githubusercontent.com/Manta-Network/rubberneck/main/config/calamari.seabird.systems/a3/etc/nginx/sites-available/substrate.conf'
    target: /etc/nginx/sites-available/substrate.conf
    sha256: 01240011fd2fac93b206fe1d58e991ba4832765a01143db565a3c02ec0ff8662
    command:
      pre:
        - test -d /etc/nginx/sites-available || sudo mkdir -p /etc/nginx/sites-available
        - test -d /etc/nginx/sites-enabled || sudo mkdir -p /etc/nginx/sites-enabled
      post:
        - sudo ln -sfr /etc/nginx/sites-available/substrate.conf /etc/nginx/sites-enabled/substrate.conf
        - sudo systemctl stop nginx.service
        - sudo systemctl start nginx.service
  -
    source: 'https://gist.githubusercontent.com/grenade/8ca7512fda41fd73c9d8dbe3fe7a548e/raw/ws.calamari.seabird.systems.conf'
    target: /etc/nginx/sites-available/ws.calamari.seabird.systems.conf
    sha256: 8efe16562db8ba515b7cabf99e0087c2b35c6936b147ef2986290eff88c6ca72
    command:
      pre:
        - test -d /etc/nginx/sites-available || sudo mkdir -p /etc/nginx/sites-available
        - test -d /etc/nginx/sites-enabled || sudo mkdir -p /etc/nginx/sites-enabled
      post:
        - sudo ln -sfr /etc/nginx/sites-available/ws.calamari.seabird.systems.conf /etc/nginx/sites-enabled/ws.calamari.seabird.systems.conf
        - systemctl is-active --quiet nginx.service && sudo systemctl restart nginx.service
  -
    source: 'https://gist.githubusercontent.com/grenade/8ca7512fda41fd73c9d8dbe3fe7a548e/raw/ws.archive.calamari.seabird.systems.conf'
    target: /etc/nginx/sites-available/ws.archive.calamari.seabird.systems.conf
    sha256: 371a5f194574975a7738bc837be8f03ae71ce16d5bde7e59e1f84d8ee0cc9242
    command:
      pre:
        - test -d /etc/nginx/sites-available || sudo mkdir -p /etc/nginx/sites-available
        - test -d /etc/nginx/sites-enabled || sudo mkdir -p /etc/nginx/sites-enabled
      post:
        - sudo ln -sfr /etc/nginx/sites-available/ws.archive.calamari.seabird.systems.conf /etc/nginx/sites-enabled/ws.archive.calamari.seabird.systems.conf
        - systemctl is-active --quiet nginx.service && sudo systemctl restart nginx.service
  -
    source: 'https://manta-ops.s3.amazonaws.com/manta-indexer/v4.0.0/manta-indexer'
    target: /usr/local/bin/manta-indexer
    sha256: c6b4afd811e363291245c26ec995a7709bdeb43732e89720527b8a3f1b58ac22
    command:
      pre:
        - test -d /usr/local/bin || sudo mkdir -p /usr/local/bin
      post:
        - sudo chmod +x /usr/local/bin/manta-indexer
        - systemctl is-active --quiet manta-indexer.service && sudo systemctl restart manta-indexer.service
  -
    source: 'https://raw.githubusercontent.com/Manta-Network/rubberneck/main/config/calamari.seabird.systems/a3/etc/manta-indexer/config.toml'
    target: /etc/manta-indexer/config.toml
    sha256: 74786a7cef47d2c837ab4e4c1f105c2c024754c7eb82424b10ea6f8755f68234
    command:
      pre:
        - test -d /etc/manta-indexer || sudo mkdir -p /etc/manta-indexer
      post:
        - systemctl is-active --quiet manta-indexer.service && sudo systemctl restart manta-indexer.service
  -
    source: 'https://raw.githubusercontent.com/Manta-Network/rubberneck/main/config/calamari.seabird.systems/a3/etc/manta-indexer/log.yaml'
    target: /etc/manta-indexer/log.yaml
    sha256: 5b937c95301f1a0ea27c8fe88e179c49fa60780dc5d3c1b90ac09709cd6ff617
    command:
      pre:
        - test -d /etc/manta-indexer || sudo mkdir -p /etc/manta-indexer
      post:
        - systemctl is-active --quiet manta-indexer.service && sudo systemctl restart manta-indexer.service
  -
    source: 'https://raw.githubusercontent.com/Manta-Network/rubberneck/main/config/calamari.seabird.systems/a3/var/lib/manta-indexer/migrations/0_schema.sql'
    target: /var/lib/manta-indexer/migrations/0_schema.sql
    sha256: c40c46c3bb3c5365da214812e5e308a4dbe24401c9bf0f32dc24672d7e9f5f04
    command:
      pre:
        - test -d /var/lib/manta-indexer/migrations || sudo mkdir -p /var/lib/manta-indexer/migrations
      post:
        - systemctl is-active --quiet manta-indexer.service && sudo systemctl restart manta-indexer.service
  -
    source: https://raw.githubusercontent.com/Manta-Network/rubberneck/main/config/calamari.seabird.systems/a3/etc/systemd/system/manta-indexer.service
    target: /etc/systemd/system/manta-indexer.service
    sha256: 2a16ffd7ccfc691c8079a86769feea2faa8b641e5554f805dfa809b8f6648c67
    command:
      pre:
        - systemctl is-active --quiet manta-indexer.service && sudo systemctl stop manta-indexer.service
        - getent passwd manta-indexer &> /dev/null || sudo useradd --system --create-home --home-dir /var/lib/manta-indexer --user-group manta-indexer
        - test -d /var/log/manta-indexer || sudo mkdir -p /var/log/manta-indexer
        - sudo ln -sf /var/log/manta-indexer /var/lib/manta-indexer/logs
        - test -d /etc/manta-indexer || sudo mkdir -p /etc/manta-indexer
        - sudo ln -sf /etc/manta-indexer /var/lib/manta-indexer/conf
        - sudo chown -R manta-indexer:manta-indexer /var/lib/manta-indexer
        - sudo chown -R manta-indexer:manta-indexer /var/log/manta-indexer
      post:
        - sudo systemctl daemon-reload
        - systemctl is-enabled --quiet manta-indexer.service || sudo systemctl enable manta-indexer.service
        - systemctl is-active --quiet manta-indexer.service || sudo systemctl start manta-indexer.service
